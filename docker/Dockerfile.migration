# =============================================================================
# Dockerfile for Database Migration Job
# This image runs database migrations before services start
# Build: docker build -f docker/Dockerfile.migration -t tiktok-migration:latest .
# =============================================================================
FROM node:20-bullseye-slim AS builder

WORKDIR /app

# Copy package files and config, install dependencies, then copy full source and build
COPY package*.json ./
COPY tsconfig*.json ./
COPY nest-cli.json ./

# Install all dependencies (including dev for build)
RUN npm ci && npm cache clean --force

# Copy full repository into builder so Nest can build apps/libs
COPY . .

# Build all apps/libs to produce dist
RUN npm run build

# =============================================================================
# Production stage
# =============================================================================
FROM node:20-bullseye-slim

# Install netcat for health checks
RUN apt-get update && apt-get install -y netcat-openbsd && rm -rf /var/lib/apt/lists/*

# Create non-root user
RUN groupadd -g 1001 nodejs && \
    useradd -m -u 1001 -g nodejs -s /bin/sh migration

WORKDIR /app

# Copy built files and dependencies
COPY --from=builder --chown=migration:nodejs /app/dist ./dist
COPY --from=builder --chown=migration:nodejs /app/node_modules ./node_modules
COPY --from=builder --chown=migration:nodejs /app/package*.json ./

# Copy migration scripts source (for ts-node fallback)
COPY --from=builder --chown=migration:nodejs /app/scripts ./scripts
COPY --from=builder --chown=migration:nodejs /app/tsconfig*.json ./

# Switch to non-root user
USER migration

# Environment variables with defaults
ENV MIGRATION_SERVICE=all
ENV FORCE_SYNC=false
ENV NODE_ENV=production

# Health check
HEALTHCHECK --interval=30s --timeout=3s \
    CMD node -e "console.log('OK')"

# Default command - run migration
CMD ["node", "dist/scripts/migrations/k8s-migrate.js"]
