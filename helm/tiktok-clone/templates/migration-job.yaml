{{- if .Values.migration.enabled }}
# =============================================================================
# Database Migration Job
# This job runs database migrations AFTER infrastructure is ready
# Using post-install/post-upgrade ensures postgres is running and DNS is resolved
# =============================================================================
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ .Release.Name }}-db-migration-{{ now | date "20060102150405" }}
  namespace: {{ .Values.namespace }}
  labels:
    app: db-migration
    chart: {{ .Chart.Name }}-{{ .Chart.Version }}
  annotations:
    # Run AFTER all resources are deployed and ready
    "helm.sh/hook": post-install,post-upgrade
    "helm.sh/hook-weight": "5"
    "helm.sh/hook-delete-policy": before-hook-creation
spec:
  ttlSecondsAfterFinished: {{ .Values.migration.ttlSecondsAfterFinished | default 600 }}
  backoffLimit: {{ .Values.migration.backoffLimit | default 3 }}
  activeDeadlineSeconds: {{ .Values.migration.activeDeadlineSeconds | default 300 }}
  template:
    metadata:
      labels:
        app: db-migration
    spec:
      restartPolicy: Never
      {{- if .Values.migration.serviceAccountName }}
      serviceAccountName: {{ .Values.migration.serviceAccountName }}
      {{- end }}

      # Init container to wait for database
      initContainers:
        - name: wait-for-postgres
          image: busybox:1.36
          command:
            - sh
            - -c
            - |
              echo "Waiting for PostgreSQL to be ready..."
              POSTGRES_HOST="{{ .Values.postgresql.service | default "postgres" }}"
              POSTGRES_PORT="{{ .Values.postgresql.port | default 5432 }}"
              MAX_RETRIES=60
              RETRY=0

              until nc -z $POSTGRES_HOST $POSTGRES_PORT; do
                RETRY=$((RETRY + 1))
                if [ $RETRY -ge $MAX_RETRIES ]; then
                  echo "PostgreSQL not ready after $MAX_RETRIES attempts, giving up!"
                  exit 1
                fi
                echo "PostgreSQL is not ready - attempt $RETRY/$MAX_RETRIES - sleeping 2s"
                sleep 2
              done
              echo "PostgreSQL is ready!"
          resources:
            requests:
              memory: "32Mi"
              cpu: "10m"
            limits:
              memory: "64Mi"
              cpu: "50m"

      containers:
        - name: migration
          image: "{{ .Values.migration.image.repository }}:{{ .Values.migration.image.tag }}"
          imagePullPolicy: {{ .Values.migration.image.pullPolicy | default .Values.global.imagePullPolicy | default "IfNotPresent" }}
          command:
            - sh
            - -c
            - |
              echo "Starting database migration..."
              echo "Target service: $MIGRATION_SERVICE"
              echo "Force sync: $FORCE_SYNC"

              # Run the migration script
              if [ -f "dist/scripts/migrations/k8s-migrate.js" ]; then
                node dist/scripts/migrations/k8s-migrate.js
              else
                echo "Migration script not found, running schema sync..."
                npx ts-node -r tsconfig-paths/register scripts/migrations/k8s-migrate.ts
              fi

              EXIT_CODE=$?
              if [ $EXIT_CODE -eq 0 ]; then
                echo "Migration completed successfully!"
              else
                echo "Migration failed with exit code $EXIT_CODE"
                exit $EXIT_CODE
              fi
          env:
            - name: MIGRATION_SERVICE
              value: {{ .Values.migration.targetService | default "all" | quote }}
            - name: FORCE_SYNC
              value: {{ .Values.migration.forceSync | default "false" | quote }}
            - name: NODE_ENV
              value: {{ .Values.global.environment | default "production" | quote }}
            # Auth DB Config
            - name: AUTH_DB_HOST
              valueFrom:
                configMapKeyRef:
                  name: tiktok-db-config
                  key: DB_HOST
            - name: AUTH_DB_PORT
              valueFrom:
                configMapKeyRef:
                  name: tiktok-db-config
                  key: DB_PORT
            - name: AUTH_DB_USERNAME
              valueFrom:
                configMapKeyRef:
                  name: tiktok-db-config
                  key: DB_USER
            - name: AUTH_DB_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: tiktok-db-secrets
                  key: DB_PASSWORD
            - name: AUTH_DB_NAME
              value: {{ .Values.migration.databases.auth | default "tiktok_auth" | quote }}
            # Video DB Config
            - name: VIDEO_DB_HOST
              valueFrom:
                configMapKeyRef:
                  name: tiktok-db-config
                  key: DB_HOST
            - name: VIDEO_DB_PORT
              valueFrom:
                configMapKeyRef:
                  name: tiktok-db-config
                  key: DB_PORT
            - name: VIDEO_DB_USERNAME
              valueFrom:
                configMapKeyRef:
                  name: tiktok-db-config
                  key: DB_USER
            - name: VIDEO_DB_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: tiktok-db-secrets
                  key: DB_PASSWORD
            - name: VIDEO_DB_NAME
              value: {{ .Values.migration.databases.video | default "tiktok_video" | quote }}
            # Interaction DB Config
            - name: INTERACTION_DB_HOST
              valueFrom:
                configMapKeyRef:
                  name: tiktok-db-config
                  key: DB_HOST
            - name: INTERACTION_DB_PORT
              valueFrom:
                configMapKeyRef:
                  name: tiktok-db-config
                  key: DB_PORT
            - name: INTERACTION_DB_USERNAME
              valueFrom:
                configMapKeyRef:
                  name: tiktok-db-config
                  key: DB_USER
            - name: INTERACTION_DB_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: tiktok-db-secrets
                  key: DB_PASSWORD
            - name: INTERACTION_DB_NAME
              value: {{ .Values.migration.databases.interaction | default "tiktok_interaction" | quote }}
            # Notification DB Config
            - name: NOTIFICATION_DB_HOST
              valueFrom:
                configMapKeyRef:
                  name: tiktok-db-config
                  key: DB_HOST
            - name: NOTIFICATION_DB_PORT
              valueFrom:
                configMapKeyRef:
                  name: tiktok-db-config
                  key: DB_PORT
            - name: NOTIFICATION_DB_USERNAME
              valueFrom:
                configMapKeyRef:
                  name: tiktok-db-config
                  key: DB_USER
            - name: NOTIFICATION_DB_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: tiktok-db-secrets
                  key: DB_PASSWORD
            - name: NOTIFICATION_DB_NAME
              value: {{ .Values.migration.databases.notification | default "tiktok_notification" | quote }}
          resources:
{{ toYaml .Values.migration.resources | indent 12 }}
{{- end }}
