{
  "__comment__": "Dashboard NestJS Overview - Hiá»ƒn thá»‹ metrics tá»« Prometheus, logs tá»« Loki, vÃ  traces tá»« Tempo",
  "annotations": {
    "list": []
  },
  "editable": true,
  "fiscalYearStartMonth": 0,
  "graphTooltip": 1,
  "id": null,
  "links": [],
  "panels": [
    {
      "__comment__": "====== ROW 1: Tá»•ng quan HTTP ======",
      "collapsed": false,
      "gridPos": { "h": 1, "w": 24, "x": 0, "y": 0 },
      "id": 100,
      "title": "HTTP Overview",
      "type": "row"
    },
    {
      "__comment__": "Panel 1: Tá»•ng sá»‘ requests/giÃ¢y (rate) trong 5 phÃºt gáº§n nháº¥t. PromQL: rate() tÃ­nh tá»‘c Ä‘á»™ thay Ä‘á»•i cá»§a counter theo thá»i gian. sum() gom táº¥t cáº£ labels láº¡i. Káº¿t quáº£: vÃ­ dá»¥ 25.3 req/s",
      "title": "Request Rate (req/s)",
      "description": "Tá»•ng sá»‘ HTTP requests má»—i giÃ¢y, tÃ­nh trung bÃ¬nh trong 5 phÃºt",
      "type": "stat",
      "datasource": { "type": "prometheus", "uid": "PBFA97CFB590B2093" },
      "gridPos": { "h": 4, "w": 6, "x": 0, "y": 1 },
      "id": 1,
      "fieldConfig": {
        "defaults": {
          "color": { "mode": "thresholds" },
          "thresholds": {
            "steps": [
              { "color": "green", "value": null },
              { "color": "yellow", "value": 100 },
              { "color": "red", "value": 500 }
            ]
          },
          "unit": "reqps"
        },
        "overrides": []
      },
      "options": {
        "reduceOptions": { "calcs": ["lastNotNull"] },
        "colorMode": "background",
        "graphMode": "area"
      },
      "targets": [
        {
          "expr": "sum(rate(http_requests_total[5m]))",
          "legendFormat": "Total req/s"
        }
      ]
    },
    {
      "__comment__": "Panel 2: Tá»· lá»‡ lá»—i (%). Äáº¿m requests cÃ³ status >= 400 chia cho tá»•ng requests. GiÃºp phÃ¡t hiá»‡n nhanh khi cÃ³ nhiá»u lá»—i xáº£y ra.",
      "title": "Error Rate (%)",
      "description": "Pháº§n trÄƒm requests tráº£ vá» lá»—i (status >= 400)",
      "type": "stat",
      "datasource": { "type": "prometheus", "uid": "PBFA97CFB590B2093" },
      "gridPos": { "h": 4, "w": 6, "x": 6, "y": 1 },
      "id": 2,
      "fieldConfig": {
        "defaults": {
          "color": { "mode": "thresholds" },
          "thresholds": {
            "steps": [
              { "color": "green", "value": null },
              { "color": "yellow", "value": 1 },
              { "color": "red", "value": 5 }
            ]
          },
          "unit": "percent",
          "max": 100,
          "min": 0
        },
        "overrides": []
      },
      "options": {
        "reduceOptions": { "calcs": ["lastNotNull"] },
        "colorMode": "background",
        "graphMode": "area"
      },
      "targets": [
        {
          "expr": "sum(rate(http_request_errors_total[5m])) / sum(rate(http_requests_total[5m])) * 100",
          "legendFormat": "Error %"
        }
      ]
    },
    {
      "__comment__": "Panel 3: Thá»i gian pháº£n há»“i P95 (95th percentile). NghÄ©a lÃ  95% requests hoÃ n thÃ nh trong thá»i gian nÃ y. histogram_quantile() tÃ­nh percentile tá»« histogram buckets.",
      "title": "P95 Response Time",
      "description": "95% requests hoÃ n thÃ nh trong thá»i gian nÃ y (giÃ¢y)",
      "type": "stat",
      "datasource": { "type": "prometheus", "uid": "PBFA97CFB590B2093" },
      "gridPos": { "h": 4, "w": 6, "x": 12, "y": 1 },
      "id": 3,
      "fieldConfig": {
        "defaults": {
          "color": { "mode": "thresholds" },
          "thresholds": {
            "steps": [
              { "color": "green", "value": null },
              { "color": "yellow", "value": 0.5 },
              { "color": "red", "value": 2 }
            ]
          },
          "unit": "s"
        },
        "overrides": []
      },
      "options": {
        "reduceOptions": { "calcs": ["lastNotNull"] },
        "colorMode": "background",
        "graphMode": "area"
      },
      "targets": [
        {
          "expr": "histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket[5m])) by (le))",
          "legendFormat": "P95"
        }
      ]
    },
    {
      "__comment__": "Panel 4: Sá»‘ services Ä‘ang UP. up == 1 nghÄ©a lÃ  Prometheus scrape service Ä‘Ã³ thÃ nh cÃ´ng.",
      "title": "Services UP",
      "description": "Sá»‘ lÆ°á»£ng services mÃ  Prometheus scrape thÃ nh cÃ´ng",
      "type": "stat",
      "datasource": { "type": "prometheus", "uid": "PBFA97CFB590B2093" },
      "gridPos": { "h": 4, "w": 6, "x": 18, "y": 1 },
      "id": 4,
      "fieldConfig": {
        "defaults": {
          "color": { "mode": "thresholds" },
          "thresholds": {
            "steps": [
              { "color": "red", "value": null },
              { "color": "yellow", "value": 3 },
              { "color": "green", "value": 5 }
            ]
          }
        },
        "overrides": []
      },
      "options": {
        "reduceOptions": { "calcs": ["lastNotNull"] },
        "colorMode": "background",
        "graphMode": "none"
      },
      "targets": [
        {
          "expr": "count(up{job!='prometheus'} == 1)",
          "legendFormat": "Services UP"
        }
      ]
    },
    {
      "__comment__": "====== ROW 2: Biá»ƒu Ä‘á»“ thá»i gian ======",
      "collapsed": false,
      "gridPos": { "h": 1, "w": 24, "x": 0, "y": 5 },
      "id": 101,
      "title": "Request Metrics Over Time",
      "type": "row"
    },
    {
      "__comment__": "Panel 5: Biá»ƒu Ä‘á»“ request rate theo thá»i gian, phÃ¢n chia theo service. GiÃºp tháº¥y service nÃ o nháº­n nhiá»u traffic nháº¥t vÃ  traffic thay Ä‘á»•i tháº¿ nÃ o.",
      "title": "Request Rate by Service",
      "description": "Sá»‘ requests/giÃ¢y theo thá»i gian, chia theo service",
      "type": "timeseries",
      "datasource": { "type": "prometheus", "uid": "PBFA97CFB590B2093" },
      "gridPos": { "h": 8, "w": 12, "x": 0, "y": 6 },
      "id": 5,
      "fieldConfig": {
        "defaults": {
          "color": { "mode": "palette-classic" },
          "custom": {
            "drawStyle": "line",
            "lineInterpolation": "smooth",
            "fillOpacity": 20,
            "pointSize": 5,
            "lineWidth": 2
          },
          "unit": "reqps"
        },
        "overrides": []
      },
      "options": {
        "legend": { "displayMode": "table", "placement": "bottom", "calcs": ["mean", "max"] },
        "tooltip": { "mode": "multi" }
      },
      "targets": [
        {
          "expr": "sum(rate(http_requests_total[5m])) by (job)",
          "legendFormat": "{{job}}"
        }
      ]
    },
    {
      "__comment__": "Panel 6: Thá»i gian pháº£n há»“i P50, P95, P99 theo thá»i gian. P50 = median (50% requests nhanh hÆ¡n). P95 = 95th percentile. P99 = 99th percentile. GiÃºp phÃ¡t hiá»‡n khi response time tÄƒng Ä‘á»™t biáº¿n.",
      "title": "Response Time Percentiles",
      "description": "P50 (median), P95, P99 response time theo thá»i gian",
      "type": "timeseries",
      "datasource": { "type": "prometheus", "uid": "PBFA97CFB590B2093" },
      "gridPos": { "h": 8, "w": 12, "x": 12, "y": 6 },
      "id": 6,
      "fieldConfig": {
        "defaults": {
          "color": { "mode": "palette-classic" },
          "custom": {
            "drawStyle": "line",
            "lineInterpolation": "smooth",
            "fillOpacity": 10,
            "lineWidth": 2
          },
          "unit": "s"
        },
        "overrides": []
      },
      "options": {
        "legend": { "displayMode": "table", "placement": "bottom", "calcs": ["mean", "max"] },
        "tooltip": { "mode": "multi" }
      },
      "targets": [
        {
          "expr": "histogram_quantile(0.50, sum(rate(http_request_duration_seconds_bucket[5m])) by (le))",
          "legendFormat": "P50 (median)"
        },
        {
          "expr": "histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket[5m])) by (le))",
          "legendFormat": "P95"
        },
        {
          "expr": "histogram_quantile(0.99, sum(rate(http_request_duration_seconds_bucket[5m])) by (le))",
          "legendFormat": "P99"
        }
      ]
    },
    {
      "__comment__": "====== ROW 3: Node.js Process Metrics ======",
      "collapsed": false,
      "gridPos": { "h": 1, "w": 24, "x": 0, "y": 14 },
      "id": 102,
      "title": "Node.js Process Metrics",
      "type": "row"
    },
    {
      "__comment__": "Panel 7: Memory usage cá»§a Node.js process. process_resident_memory_bytes lÃ  default metric tá»« prom-client collectDefaultMetrics(). GiÃºp phÃ¡t hiá»‡n memory leak.",
      "title": "Memory Usage (RSS)",
      "description": "Resident Set Size - bá»™ nhá»› thá»±c táº¿ Ä‘ang dÃ¹ng bá»Ÿi Node.js process",
      "type": "timeseries",
      "datasource": { "type": "prometheus", "uid": "PBFA97CFB590B2093" },
      "gridPos": { "h": 8, "w": 12, "x": 0, "y": 15 },
      "id": 7,
      "fieldConfig": {
        "defaults": {
          "color": { "mode": "palette-classic" },
          "custom": {
            "drawStyle": "line",
            "lineInterpolation": "smooth",
            "fillOpacity": 20,
            "lineWidth": 2
          },
          "unit": "bytes"
        },
        "overrides": []
      },
      "options": {
        "legend": { "displayMode": "table", "placement": "bottom", "calcs": ["mean", "max"] },
        "tooltip": { "mode": "multi" }
      },
      "targets": [
        {
          "expr": "process_resident_memory_bytes",
          "legendFormat": "{{job}}"
        }
      ]
    },
    {
      "__comment__": "Panel 8: Event loop lag - Ä‘o Ä‘á»™ trá»… cá»§a Node.js event loop. Náº¿u event loop bá»‹ block (CPU-intensive task), lag sáº½ tÄƒng. Metric nÃ y chá»‰ cÃ³ khi collectDefaultMetrics() Ä‘Æ°á»£c báº­t.",
      "title": "Event Loop Lag",
      "description": "Äá»™ trá»… event loop cá»§a Node.js (giÃ¢y). Cao = event loop Ä‘ang bá»‹ block",
      "type": "timeseries",
      "datasource": { "type": "prometheus", "uid": "PBFA97CFB590B2093" },
      "gridPos": { "h": 8, "w": 12, "x": 12, "y": 15 },
      "id": 8,
      "fieldConfig": {
        "defaults": {
          "color": { "mode": "palette-classic" },
          "custom": {
            "drawStyle": "line",
            "lineInterpolation": "smooth",
            "fillOpacity": 20,
            "lineWidth": 2
          },
          "unit": "s"
        },
        "overrides": []
      },
      "options": {
        "legend": { "displayMode": "table", "placement": "bottom", "calcs": ["mean", "max"] },
        "tooltip": { "mode": "multi" }
      },
      "targets": [
        {
          "expr": "rate(nodejs_eventloop_lag_seconds[5m])",
          "legendFormat": "{{job}}"
        }
      ]
    },
    {
      "__comment__": "====== ROW 4: Logs ======",
      "collapsed": false,
      "gridPos": { "h": 1, "w": 24, "x": 0, "y": 23 },
      "id": 103,
      "title": "Application Logs (from Loki)",
      "type": "row"
    },
    {
      "__comment__": "Panel 9: Logs tá»« Loki - hiá»ƒn thá»‹ táº¥t cáº£ service logs. LogQL query: {job='docker'} láº¥y táº¥t cáº£ Docker container logs. CÃ³ thá»ƒ filter thÃªm báº±ng: {service='api-gateway'} |= 'error'",
      "title": "All Service Logs",
      "description": "Logs tá»« táº¥t cáº£ services (tá»« Loki qua Promtail)",
      "type": "logs",
      "datasource": { "type": "loki", "uid": "P8E80F9AEF21F6940" },
      "gridPos": { "h": 10, "w": 24, "x": 0, "y": 24 },
      "id": 9,
      "options": {
        "showTime": true,
        "showLabels": true,
        "showCommonLabels": false,
        "wrapLogMessage": true,
        "prettifyLogMessage": true,
        "enableLogDetails": true,
        "sortOrder": "Descending",
        "dedupStrategy": "none"
      },
      "targets": [
        {
          "refId": "A",
          "expr": "{container=~\"tiktok_.+\"}",
          "queryType": "range",
          "legendFormat": ""
        }
      ]
    },
    {
      "__comment__": "====== ROW 5: Tracing â€” Tempo ======",
      "collapsed": false,
      "gridPos": { "h": 1, "w": 24, "x": 0, "y": 34 },
      "id": 500,
      "title": "Distributed Tracing (Tempo)",
      "type": "row"
    },
    {
      "__comment__": "Panel: Trace duration (P95) theo service. PromQL dÃ¹ng metrics do Tempo metrics_generator táº¡o ra. traces_spanmetrics_latency_bucket lÃ  histogram tá»• há»£p tá»« táº¥t cáº£ spans.",
      "title": "Trace Duration P95 by Service",
      "description": "P95 latency theo service, tá»« span metrics do Tempo sinh ra",
      "type": "timeseries",
      "datasource": { "type": "prometheus", "uid": "PBFA97CFB590B2093" },
      "gridPos": { "h": 8, "w": 12, "x": 0, "y": 35 },
      "id": 10,
      "fieldConfig": {
        "defaults": {
          "color": { "mode": "palette-classic" },
          "unit": "s",
          "custom": {
            "drawStyle": "line",
            "lineWidth": 2,
            "fillOpacity": 10,
            "pointSize": 5,
            "showPoints": "auto"
          }
        },
        "overrides": []
      },
      "options": {
        "tooltip": { "mode": "multi" },
        "legend": { "displayMode": "table", "placement": "bottom" }
      },
      "targets": [
        {
          "expr": "histogram_quantile(0.95, sum(rate(traces_spanmetrics_latency_bucket[5m])) by (le, service))",
          "legendFormat": "{{service}}"
        }
      ]
    },
    {
      "__comment__": "Panel: Sá»‘ spans/giÃ¢y theo service. traces_spanmetrics_calls_total lÃ  counter do Tempo metrics_generator táº¡o ra, Ä‘áº¿m tá»•ng sá»‘ spans nháº­n Ä‘Æ°á»£c.",
      "title": "Span Rate by Service",
      "description": "Sá»‘ spans Ä‘Æ°á»£c táº¡o má»—i giÃ¢y theo service",
      "type": "timeseries",
      "datasource": { "type": "prometheus", "uid": "PBFA97CFB590B2093" },
      "gridPos": { "h": 8, "w": 12, "x": 12, "y": 35 },
      "id": 11,
      "fieldConfig": {
        "defaults": {
          "color": { "mode": "palette-classic" },
          "unit": "ops",
          "custom": {
            "drawStyle": "bars",
            "lineWidth": 1,
            "fillOpacity": 50,
            "stacking": { "mode": "normal" }
          }
        },
        "overrides": []
      },
      "options": {
        "tooltip": { "mode": "multi" },
        "legend": { "displayMode": "table", "placement": "bottom" }
      },
      "targets": [
        {
          "expr": "sum(rate(traces_spanmetrics_calls_total[5m])) by (service)",
          "legendFormat": "{{service}}"
        }
      ]
    },
    {
      "__comment__": "Panel: HÆ°á»›ng dáº«n xem traces chi tiáº¿t. Traces khÃ´ng hiá»ƒn thá»‹ trá»±c tiáº¿p trÃªn dashboard, cáº§n dÃ¹ng Explore â†’ Tempo Ä‘á»ƒ xem waterfall timeline.",
      "title": "ðŸ’¡ Xem Traces Chi Tiáº¿t",
      "description": "HÆ°á»›ng dáº«n xem distributed traces trong Grafana",
      "type": "text",
      "gridPos": { "h": 4, "w": 24, "x": 0, "y": 43 },
      "id": 12,
      "options": {
        "mode": "markdown",
        "content": "### CÃ¡ch xem traces:\n1. **Grafana â†’ Explore** (biá»ƒu tÆ°á»£ng la bÃ n) â†’ chá»n datasource **Tempo**\n2. **Search tab** â†’ chá»n Service Name â†’ Run query\n3. Click vÃ o 1 trace Ä‘á»ƒ xem **waterfall timeline** (thá»i gian tá»«ng span)\n4. Tá»« trace, click **Logs for this span** Ä‘á»ƒ nháº£y sang Loki xem log chi tiáº¿t\n\n> ðŸ’¡ Tip: Má»—i request táº¡o 1 Trace ID duy nháº¥t, theo dÃµi xuyÃªn suá»‘t: API Gateway â†’ Auth/Video/Interaction Service â†’ Database/Redis"
      }
    }
  ],
  "schemaVersion": 39,
  "tags": ["nestjs", "monitoring", "tracing"],
  "templating": {
    "list": []
  },
  "time": {
    "from": "now-1h",
    "to": "now"
  },
  "timepicker": {},
  "timezone": "browser",
  "title": "NestJS Overview",
  "uid": "nestjs-overview",
  "version": 1
}
